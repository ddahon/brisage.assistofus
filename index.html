<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur Brisage Dofus</title>
    <!-- Tailwind CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@latest/dist/tailwind.min.css" rel="stylesheet">
    <!-- Alpine.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@latest/dist/cdn.min.js" defer></script>
</head>

<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4">
        <h1 class="text-xl font-bold">Calculateur Brisage Dofus</h1>
    </header>

    <!-- Main Content -->
    <main x-data="main" class="flex flex-col items-center  min-h-screen">
        <div class="mt-44 mb-12 w-1/2">
            <input type="text" x-model="query" @input="fetchSuggestions" placeholder="Rechercher un objet..."
                class="p-2 border border-gray-300 rounded w-full">
            <!-- Suggestions dropdown -->
            <div x-show="suggestions.length > 0" class="mt-2">
                <ul class="bg-white border border-gray-300 rounded shadow-lg">
                    <template x-for="suggestion in suggestions" :key="suggestion.id">
                        <li class="p-2 hover:bg-gray-100 cursor-pointer flex items-center border-b border-gray-300"
                            @click="selectSuggestion(suggestion)">
                            <img :src="suggestion.img" :alt="suggestion.name.fr" class="m-1">
                            <label x-text="suggestion.name.fr"></label>
                        </li>
                    </template>
                </ul>
            </div>
        </div>


        <div x-show="selectedItem != null" class="w-1/2  flex flex-row grow space-x-10">
            <!-- Item card -->
            <div class="bg-gray-600 border border-gray-300 rounded shadow-lg  w-1/2 text-white">
                <div class="flex flex-row p-4 items-center justify-between border-b-gray-300 border-b h-32">
                    <h2 x-text="selectedItem?.name?.fr"></h2>
                    <img :src="selectedItem?.img" class="bg-gray-800 p-3 ml-3">
                </div>
                <ul>
                    <template x-for="stat in itemStats">
                        <li class="pr-36 pl-3 py-2 hover:bg-green-500 cursor-pointer flex items-center ">
                            <img :src="'https://dofusdb.fr/icons/characteristics/' + stat?.characteristicDetails?.asset + '.png'"
                                class="mr-1">
                            <label x-text="stat?.from + ' ' + stat?.characteristicDetails?.name?.fr"></label>
                        </li>
                    </template>
                </ul>
            </div>

            <!-- Runes Preview -->
            <div class="bg-gray-600 border border-gray-300 rounded shadow-lg  w-1/2 text-white">
                <div class="flex flex-row p-4 items-center border-b-gray-300 border-b h-32">
                    <h2 x-text="focusedStat == null ? 'Aucun focus' : focusedStat?.name?.fr">
                    </h2>
                </div>
                <ul>
                    <template x-for="stat in itemStats">
                        <li class="pr-36 pl-3 py-2 flex items-center ">
                            <img :src="stat?.rune?.img" class="mr-1 w-8 h-8 ">
                        </li>
                    </template>
                </ul>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class=" bg-blue-600 text-white p-4 mt-auto">
        <p class="text-center">&copy; 2023 My App</p>
    </footer>

    <script>
        function fetchRunes(skip = 0) {
            return fetch(`https://api.dofusdb.fr/items?typeId[$ne]=203&$sort=-id&slug.fr[$search]=&typeId[$in][]=78&level[$gte]=0&level[$lte]=200&$skip=${skip}&lang=fr`)
                .then(response => response.json())
        }

        function fetchRunesPages() {
            return fetchRunes()
                .then((data) => {
                    let promises = []
                    for (let i = 0; i < data.total; i += 10) {
                        promises.push(fetchRunes(skip = i))
                    }
                    return Promise.all(promises)
                })
        }

        function fetchAllRunes() {
            fetchRunesPages()
                .then((pages) => pages.map((page) => page.data).flat().filter((rune) => rune.effects.length > 0))
                .then(fetchPowerRates)
                .then(mapRunesToCharacteristics)
                .then(console.log)

                .then((runesMap) => this.allRunes = runesMap)
                .then(() => console.log(this.allRunes))
        }

        function mapRunesToCharacteristics(runesList) {
            return runesList.reduce((acc2, rune) => ({ ...acc2, [rune?.effects[0]?.characteristic]: rune }), {})
        }

        function fetchPowerRates(runes) {
            return Promise.all(
                runes.map((rune) =>
                    fetchEffectPowerRate(rune?.possibleEffects[0].effectId)
                        .then((x) => ({ effectPowerRate: x, diceNum: rune?.possibleEffects[0].diceNum, ...rune }))
                ))
        }

        function fetchEffectPowerRate(effectId) {
            return fetch(`https://api.dofusdb.fr/effects/${effectId}`)
                .then((response) => response.json())
                .then((data) => data.effectPowerRate)
        }

        function getStatRange(from, to) {
            range = to == 0 ? `${from}` : `${from} Ã  ${to}`
            return range
        }

        function fetchSuggestions() {
            if (this.query.length > 0) {
                fetch(`https://api.dofusdb.fr/items?typeId[$ne]=203&$sort=-id&typeId[$in][]=1&typeId[$in][]=9&typeId[$in][]=2&typeId[$in][]=3&typeId[$in][]=4&typeId[$in][]=5&typeId[$in][]=6&typeId[$in][]=7&typeId[$in][]=8&typeId[$in][]=19&typeId[$in][]=20&typeId[$in][]=21&typeId[$in][]=22&typeId[$in][]=114&typeId[$in][]=271&typeId[$in][]=11&typeId[$in][]=82&typeId[$in][]=17&typeId[$in][]=10&typeId[$in][]=16&slug.fr[$search]=${this.query}&level[$gte]=0&level[$lte]=200&$skip=0&lang=fr`)
                    .then(response => response.json())
                    .then(data => {
                        this.suggestions = data.data;
                    });
            } else {
                this.suggestions = [];
            }
        }

        function selectSuggestion(suggestion) {
            // Enrich characteristics
            console.log(`Selected: ${suggestion}`)
            fetchStats(suggestion)
                .then((stats) => {
                    this.query = suggestion.name.fr;
                    this.suggestions = [];
                    this.selectedItem = suggestion
                    this.itemStats = stats
                })
        }

        function fetchStats(suggestion) {
            return Promise.all(suggestion.effects.filter((effect) => effect.category == 0).map((effect) =>
                fetchCharacteristic(effect.characteristic).then((characteristic) => ({ characteristicDetails: characteristic, range: getStatRange(effect.from, effect.to), rune: this.allRunes[characteristic.id], ...effect })))
            )
        }

        function fetchCharacteristic(characteristicId) {
            return fetch(`https://api.dofusdb.fr/characteristics/${characteristicId}`)
                .then(response => response.json())
        }

        document.addEventListener('alpine:init', () => {
            fetchAllRunes()
            Alpine.data('main', () => ({
                query: '',
                suggestions: [],
                selectedItem: null,
                itemStats: [],
                focusedStat: null,
                allRunes: null,
                selectSuggestion,
                fetchSuggestions
            }))
        })
    </script>
</body>

</html>